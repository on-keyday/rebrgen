import subprocess as sp
import os
import sys

LANG_NAME = sys.argv[1]
BUILD_MODE = "native" if len(sys.argv) < 3 else sys.argv[2]
BUILD_TYPE = "Debug" if len(sys.argv) < 4 else sys.argv[3]


# cmake --build ./built/native/Debug --target gen_template
DEFAULT_FUTILS_DIR = (
    "C:/workspace/utils_backup" if sys.platform == "win32" else "./utils"
)


from pathlib import Path

sys.path.append(str(Path(__file__).parent))
from util import execute

execute(
    [
        "cmake",
        "--build",
        f"./built/{BUILD_MODE}/{BUILD_TYPE}",
        "--target",
        "gen_template",
    ],
    env={
        "FUTILS_DIR": os.getenv(
            "FUTILS_DIR",
            DEFAULT_FUTILS_DIR,
        ),
    },
    capture=False,
)

# cmake --install ./built/native/Debug --component gen_template
execute(
    [
        "cmake",
        "--install",
        f"./built/{BUILD_MODE}/{BUILD_TYPE}",
        "--component",
        "gen_template",
    ],
    env={
        "FUTILS_DIR": os.getenv(
            "FUTILS_DIR",
            DEFAULT_FUTILS_DIR,
        ),
    },
    capture=False,
)
ROOT_DIR = "src/old"

if not os.path.exists(f"{ROOT_DIR}/bm2{LANG_NAME}"):
    os.makedirs(f"{ROOT_DIR}/bm2{LANG_NAME}")
if not os.path.exists(f"{ROOT_DIR}/bm2{LANG_NAME}/config.json"):
    CONFIG = execute(
        ["./tool/gen_template", "--lang", LANG_NAME, "--mode", "config"],
        None,  # Added None for the env argument
    )
    with open(f"{ROOT_DIR}/bm2{LANG_NAME}/config.json", "wb") as f:
        f.write(CONFIG)
if not os.path.exists(f"{ROOT_DIR}/bm2{LANG_NAME}/hook"):
    os.makedirs(f"{ROOT_DIR}/bm2{LANG_NAME}/hook")
    NOTE = f"""
// Code generated by bm2{LANG_NAME} of https://github.com/on-keyday/rebrgen

// This language is still in development and not yet working.
// Please refer to the following link for more information.
// if you want to contribute, please refer to the following link.
// https://github.com/on-keyday/rebrgen
"""
    with open(f"{ROOT_DIR}/bm2{LANG_NAME}/hook/file_top.txt", "w") as f:
        f.write(NOTE)

# .\tool\gen_template --lang %LANG_NAME% --header --hook-dir src\bm2%LANG_NAME%\hook %DEBUG_OPTION% > src\bm2%LANG_NAME%\bm2%LANG_NAME%.hpp
HEADER = execute(
    [
        "./tool/gen_template",
        "--lang",
        LANG_NAME,
        "--mode",
        "header",
        "--hook-dir",
        f"{ROOT_DIR}/bm2{LANG_NAME}/hook",
    ],
    None,
)

# .\tool\gen_template --config-file src\bm2%LANG_NAME%\config.json --hook-dir src\bm2%LANG_NAME%\hook %DEBUG_OPTION% > src\bm2%LANG_NAME%\bm2%LANG_NAME%.cpp
GENERATOR = execute(
    [
        "./tool/gen_template",
        "--mode",
        "generator",
        "--config-file",
        f"{ROOT_DIR}/bm2{LANG_NAME}/config.json",
        "--hook-dir",
        f"{ROOT_DIR}/bm2{LANG_NAME}/hook",
    ],
    None,
)


# .\tool\gen_template --lang %LANG_NAME% --main --hook-dir src\bm2%LANG_NAME%\hook %DEBUG_OPTION%> src\bm2%LANG_NAME%\main.cpp
MAIN = execute(
    [
        "./tool/gen_template",
        "--lang",
        LANG_NAME,
        "--mode",
        "main",
        "--hook-dir",
        f"{ROOT_DIR}/bm2{LANG_NAME}/hook",
    ],
    None,
)

# .\tool\gen_template --lang %LANG_NAME% --cmake --hook-dir src\bm2%LANG_NAME%\hook %DEBUG_OPTION% > src\bm2%LANG_NAME%\CMakeLists.txt
CMAKE = execute(
    [
        "./tool/gen_template",
        "--lang",
        LANG_NAME,
        "--mode",
        "cmake",
        "--hook-dir",
        f"src/old/bm2{LANG_NAME}/hook",
    ],
    None,
)


def write_with_cached(file_path: str, content: bytes):
    cached = False
    if os.path.exists(file_path):
        with open(file_path, "rb") as f:
            if f.read() == content:
                print(f"Cached: {file_path}")
                cached = True
    if not cached:
        with open(file_path, "wb") as f:
            f.write(content)
        print(f"Generated: {file_path}")


write_with_cached(f"{ROOT_DIR}/bm2{LANG_NAME}/bm2{LANG_NAME}.hpp", HEADER)
write_with_cached(f"{ROOT_DIR}/bm2{LANG_NAME}/bm2{LANG_NAME}.cpp", GENERATOR)
write_with_cached(f"{ROOT_DIR}/bm2{LANG_NAME}/main.cpp", MAIN)
write_with_cached(f"{ROOT_DIR}/bm2{LANG_NAME}/CMakeLists.txt", CMAKE)
