# Gemini Analysis of the rebrgen Repository

## Project Overview

- **rebrgen:** A generator construction project for `brgen`.
- **brgen:** A tool that uses a Domain Specific Language (DSL) to define binary formats and generate code (structs, encoders, decoders) in various programming languages.
- **Core Functionality:** `rebrgen` takes `brgen`'s Abstract Syntax Tree (AST) as input, transforms it into an intermediate representation called `BinaryModule`, and then uses language-specific generators (`bm2{lang}`) to produce the final code.

## Key Directories

- `brgen/`: The base `brgen` project, included as a submodule.
- `src/`: Contains the source code for the generators.
- `src/bm/`: Defines the `BinaryModule` intermediate representation.
- `src/bmgen/`: The tool that converts the `brgen` AST to the `BinaryModule` format.
- `src/bm2/`: Common code for the language-specific generators.
- `src/bm2{lang_name}/`: Source code for each language-specific generator. These are generated by the "generator-generator".
- `script/`: Build, generation, and testing scripts.
- `tool/`: Compiled tool executables.
- `save/`: Temporary directory for generated code.
- `testkit/`: Testing framework for the generated code.

## Development Workflow

1.  **Define Binary Format:** Create a `.bgn` file using the `brgen` DSL.
2.  **Generate `BinaryModule`:** The `bmgen` tool processes the `.bgn` file and creates a `BinaryModule` representation.
3.  **Generate Language-Specific Generator:** The `script/generate` script uses the `src/bm2/gen_template` to create a language-specific generator (e.g., `tool/bm2python`).
4.  **Generate Code:** The language-specific generator (`tool/bm2{lang_name}`) is executed to generate the final code in the target language.
5.  **Testing:** The `script/run_cmptest` script runs tests on the generated code.

## Important Considerations for Refactoring

- **Generated Code:** The files in `src/bm2{lang_name}/*.cpp` and `src/bm2{lang_name}/*.hpp` are auto-generated. **Do not edit them directly.** Changes should be made to the templates in `src/bm2/gen_template` or the hook files in `src/bm2{lang_name}/hook`.
- **Hand-written Generators:** `bm2rust` and `bm2cpp` are handwritten and do not follow the generator-generator pattern.
- **Configuration:** Language-specific configurations are managed in `src/bm2{lang_name}/config.json`.
- **Hooks:** Language-specific logic is implemented using "hooks," which are C++ code snippets in the `src/bm2{lang_name}/hook/` directory.

# Current Task:

Reconstructing gen_template from scratch in src/bm2/gen_template2.
You're already created minimum code structure in src/bm2/gen_template2, so continue with them.
read docs/complexity_reduction_plan.md and docs/refactoring_plan.md for consideration.
Emphasis on separating the structure generating from writing the actual code.
