# RE:brgen

RE:brgen (rebrgen,https://github.com/on-keyday/rebrgen) is a generator construction project for brgen(https://github.com/on-keyday/brgen)

# What is brgen

brgen is a project to create 1. DSL that represents binary format simply and effective, and 2. code generators that generates usable struct/encoder/decoder/etc... tuples in several programming languages.

rebrgen is part of 2.

# Directories

- brgen/ - base brgen directory as submodule (same content as https://github.com/on-keyday/brgen)
  - example/ - example set of brgen DSL
- src/ - source code

  - bm/ - binary module definition
    - binary_module.bgn - definition base of binary_module.hpp and binary_module.cpp. this defines BinaryModule structure and AbstractOp enum and etc... for code generation base.
    - binary_module.hpp and binary_module.cpp - generated file from binary_module.bgn
  - bmgen/ - translate brgen AST(as represented in brgen/web/doc/content/docs/ast.md) to BinaryModule (defined in binary_module.bgn)
    - transform/ - Binary Module transformation logic
    - main.cpp - entry point
  - bm2/ - generator common tools and generator-generator
    - gen_template/ - generator-generator source code (including entry point)
  - bm2{lang_name}/ - generator for lang_name. lang name list can be get by script/list_lang.py. these generators generate target code from BinaryModule
    - DO NOT edit `src/bm2{lang_name}/*.[h|c]pp` directly
    - bm2hexmap - map hex representation to format. this is not a code generator.
    - bm2rust and bm2cpp - these are written by hand before generator-generator created
    - hook/ - each hook directory
    - config.json - placeholder and basic language configurations
  - test/ - test input files (\*.bgn)
    - test_cases.bgn - main test cases
    - crash/ - files that caused program crash in past

- script/ - build scripts, code generation, etc... they are script file

  - these tools have suffix .ps1,.bat or .sh
  - binary_module - generate src/bm/binary_module.hpp and src/bm/binary_module.cpp
  - list_lang.py - list up language names
  - build - build tools
  - generate - build generator-generator(`tool\gen_template`) and generate the code generators (`tool\bm2{lang_name}`)
  - run_generated - build the code generators (`tool\bm2{lang_name}`) and run code generators

- save/ - testing or temporary objects directory (ignored by .gitignore)
  - {lang_name}/ - directory containing each language generated code
- tool/ - built tools installed (tool names are same as src/{dir_name}). they are executable file, not script(ignored by .gitignore)
- web/ - built tools for WebPlayground (ignored by .gitignore)
- docs/ - documentation files (currently some of them are generated by AI and not enough correctness)
- testkit/ - generated generator testing framework (auto generated by `script/generate`)
  - inputs.json - test input definitions
  - cmptest.json - auto generated runner input. this contains copy of `inputs.json`

# Development Cycle

Action order below is NO MATTER. You can choose actions below as if you need

## 0. Important Constraints

- **Do not edit `src/bm2{lang_name}/*.[h|c]pp` directly**: Avoid manual edits in these files because they are auto generated file. Before you modify, ensure following this rule.
- **Read and Update `docs/cline`**: Before you act, you have to write previous `docs/cline`. write your plan and action each time when you found the important things to note at `docs/cline` directory.

## 1. Setup and Configuration

- **Edit `bm2{lang_name}/config.json`**: Modify language-specific placeholders. Base templates are generated using `tool\gen_template --mode config`.
- **Add new config to `config.json`**: Modify `Flags` in `bm2/gen_template/flags.hpp` and add the config name to `MAP_TO_MACRO`.
- **Edit `LANG_LIST` in `script/generate.py`**: Add new languages by updating the language list and running `script/generate`.

## 2. Template and Hook Management

- **Modify `src/bm2/gen_template/`**: For language-independent logic, youâ€™ll need to modify these templates.
- **Modify or add files in `src/bm2{lang_name}/hook/`**: For language-specific custom logic, edit these files based on the hook definitions. hook file is piece of C++ code that is not complete by itself. (some exception exists like flags.txt, cmptest_build.txt,cmptest_run.txt)
- **Check hook definitions**: Use `tool\gen_template --print-hooks` to ensure the desired hook file exists before creating it.
- **Read documentation**: `docs/template_parameters.md` for understanding placeholder usage in hooks and configuration files. Regenerate the documentation with `tool\gen_template --mode docs-markdown`.

## 3. Code Generation

- **Generate code**: Use `script/generate` to generate code generators and also specify a DSL file with `script/generate {brgen DSL file}`.
- **Run generated generator**: Use `script/run_generated` to execute generated code and save results in `save/{lang_name}/save.{language_specific_suffix}`.

## 4. Testing

The goal of test is to `PASS` the `script/run_cmptest`

- **Add a test case**: Add a test case file in `src/test/{test_name}.bgn`.
- **Run test case**: Execute the generated test case using `script/generate src/test/{test_name}.bgn`.
- **Run generated generator test**: Use `script/run_cmptest` to execute unit tests for generated generator. you can change input by modifying `testkit/inputs.json`. You MUST NOT write to `setup.py` directly. write python code of `setup.py` into `hook/cmptest_build.txt` instead

## 5. Debugging and Maintenance

- **Ignore `Unimplemented` in `src/bm2{lang_name}/bm2{lang_name}.cpp`**: Don't worry about `Unimplemented` unless it causes issues in `save/{lang_name}/save.{language_specific_suffix}`.
- **Locate hook mappings**: Use the comments `// load hook: <hook name>` and `// end hook: <hook name>` in `bm2{lang_name}/*.cpp` to map hook names to hook files.

## 6. Execution Environment

- **Use PowerShell or Bash**: Depending on the OS (Windows or Linux), use PowerShell or Bash for script execution.

# Current Development Phase

Now phase is early of project.
In some aspect, generated code may looks dirty (e.g. not good naming like tmpXXX,redundant processing) but
this kind improvement is future work, NOT NOW.

Current goal is to make code generator-generator work

Currently, you should implement inner gen_template/ first if the Unimplemented task found
