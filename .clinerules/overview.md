# RE:brgen

RE:brgen (rebrgen,https://github.com/on-keyday/rebrgen) is a generator construction project for brgen(https://github.com/on-keyday/brgen)

# What is brgen

brgen is a project to create 1. DSL that represents binary format simply and effective, and 2. code generators that generates usable struct/encoder/decoder/etc... tuples in several programming languages.

rebrgen is part of 2.

# Directories

- brgen/ - base brgen directory as submodule (same content as https://github.com/on-keyday/brgen)
  - example/ - example set of brgen DSL
- src/ - source code

  - bm/ - binary module definition
    - binary_module.bgn - definition base of binary_module.hpp and binary_module.cpp (DSL). this defines BinaryModule structure and AbstractOp enum and etc... for code generation base.
    - binary_module.hpp and binary_module.cpp - generated file from binary_module.bgn
  - bmgen/ - translate brgen AST(as represented in brgen/web/doc/content/docs/ast.md) to BinaryModule (defined in binary_module.bgn)
    - transform/ - Binary Module transformation logic
    - main.cpp - entry point
  - bm2/ - generator common tools and generator-generator
    - gen_template/ - generator-generator source code (including entry point)
  - bm2{lang_name}/ - generator for lang_name. lang name list can be get by script/list_lang.py. these generators generate target code from BinaryModule
    - bm2hexmap - map hex representation to format. this is not a code generator.
    - bm2rust and bm2cpp - these are written by hand before generator-generator created
    - hook/ - each hook directory
    - config.json - placeholder and basic language configurations
  - test/ - test input files (\*.bgn)
    - test_cases.bgn - main test cases
    - crash/ - files that caused program crash in past

- script/ - build scripts, code generation, etc...

  - these tools have suffix .ps1,.bat or .sh
  - binary_module - generate src/bm/binary_module.hpp and src/bm/binary_module.cpp
  - list_lang.py - list up language names
  - build - build tools
  - generate - build generator-generator(`tool\gen_template`) and generate the code generators (`tool\bm2{lang_name}`)
  - run_generated - build the code generators (`tool\bm2{lang_name}`) and run code generators

- save/ - testing or temporary objects directory (ignored by .gitignore)
  - {lang_name}/ - directory containing each language generated code
- tool/ - built tools installed (tool names are same as src/{dir_name}) (ignored by .gitignore)
- web/ - built tools for WebPlayground (ignored by .gitignore)
- docs/ - documentation files (currently some of them are generated by AI and not enough correctness)

# Development Cycle

Action order below is NO MATTER. You can choose actions below as if you need

- you can use powershell for windows or bash for linux
- DO NOT EDIT `bm2{lang_name}/*.[h|c]pp` directly.

- Before you run test case, you may add test case file in `src/test/{test_name}.bgn` and use it as `script/generate src/test/{test_name}.bgn`

- modify src/bm2/gen_template/ for language independent logic
- modify src/bm2{lang_name}/config.json for language specific placeholders. base templates are generated by `tool\gen_template --mode config`
- to add new config for config.json, edit `Flags` in `bm2/gen_template/flags.hpp` and add config name to `MAP_TO_MACRO`
- modify or add files in src/bm2{lang_name}/hook/ for language specific custom logic. you can get basic hook definition in src/bm2/hook_list.bgn and can get by executing `tool\gen_template --print-hooks`. before you want to create hook file, check this command to ensure the desired hook file name exists
- you can run `script/generate` for generate the code generators. also, you can use `script/generate {brgen DSL file}` to specify DSL file.
- you can run `script/run_generated` to run the generated code generators and save the result in `save/{lang_name}/save.{language_specific_suffix}`

- you can read document on `docs/template_parameters.md` for what kind of variable can you use for writing hook and how to use placeholder in `config.json`. to regenerate this document, use `tool\gen_template --mode docs-markdown`

- To add new languages, first edit `LANG_LIST` in `script/generate.py` and then run `script/generate`

- you can find `// load hook: <hook name>` and `// end hook: <hook name>` comment in `bm2{lang_name}/*.cpp`. This is good to find mapping between hook name and hook file.

- you MUST ignore `Unimplemented` in `src/bm2{lang_name}/bm2{lang_name}.cpp` unless it cause `Unimplemented` in `save/{lang_name}/save.{language_specific_suffix}`

- Finally, put together summary of what you did in the `docs/cline` directory.

# Current Development Phase

Now phase is early of project.
In some aspect, generated code may looks dirty (e.g. not good naming like tmpXXX,redundant processing) but
this kind improvement is future work, NOT NOW.

Current goal is to make code generator-generator work

Currently, you should implement inner gen_template/ first if the Unimplemented task found
