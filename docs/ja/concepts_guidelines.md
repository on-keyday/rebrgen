## 6. 重要な概念とガイドライン

### 6.1 マクロの使用法 (MAYBEマクロ)
コードベースでは、特にエラー処理のためにC++マクロ、特に`MAYBE`マクロが広範に使用されています。これは、Haskellのdo記法やRustの`?`演算子と同様に、エラー処理を透過的にすることで可読性と保守性を向上させることを目的とした意図的な設計選択です。`MAYBE(x, expr)`マクロは、エラー状態 (空の`expected`または`nullptr`) を処理し、早期リターンを実行します。これらはすべてRAIIを保持し、`Error::as<U>()`を介して柔軟でコンテキストを意識したエラー処理を可能にします。

### 6.2 エラー修正戦略
`undefined symbol`や`type mismatch`のようなコンパイルエラーに遭遇した場合、`extended_binary_module.hpp`、`mapping.hpp`、およびその他の関連する`.hpp`ファイルで定義 (特に型定義) を参照することが重要です。推測を避け、必要に応じて常に`ReadFile`アクションを使用してデータを再ロードしてください。マクロ展開は、エラーメッセージに直接関係しない限り、一般的に無視すべきです。問題は通常、定義自体の誤解にあるためです。

### 6.3 アクションメンタルモデル
開発を行う際は、常に`ebm2<lang name>` (または`python script/unictest.py`) を実行して現在の段階を確認することから始めます。デバッグは通常、TODOや欠落しているフラグメントに対応するビジター/コードを見つけることを含みます。コンパイルエラーの場合、推測やキャッシュされた知識に頼るよりも、`extended_binary_module.hpp`、`mapping.hpp`、およびその他の`.hpp`ファイルで定義をチェックすることを優先します。

### 6.4 コード生成アーキテクチャ
`ebmcodegen`は言語に依存しないテンプレートを生成します。言語固有の機能 (例: Rustの`#[derive(Default)]`、`pub`可視性) は、言語固有のビジターフック (例: `ebm2rust`のビジター) で実装されます。

### 6.5 ビルドプロセス順序
正しいビルド順序は、`script/ebmcodegen.py` (言語の追加または`main.cpp`の更新用) の後に`script/build.py`が続きます。`script/ebmcodegen.py`は特定の言語の自動生成された`main.cpp`を更新し、`script/build.py`はそれを使用して実行可能ファイルを作成します。`script/ebmtemplate.py`は、新しいビジターフックを作成する際に`main.cpp`のタイムスタンプを更新し、`script/build.py`が実行可能ファイルを再ビルドするようにします。既存のビジターフックファイルへの変更は、CMakeによって`#include`依存関係を介して自動的に検出され、`script/build.py`が実行されたときに再ビルドがトリガーされます。
