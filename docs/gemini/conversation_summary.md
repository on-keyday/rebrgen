# Conversation Summary and Instructions Log

**Date:** 2025-12-21
**Topic:** ebm2c Implementation and Debugging

## Key User Instructions

1.  **Workflow & Testing:**
    -   Always run `python script/unictest.py --target-runner ebm2c --target-input ipv6_test --print-stdout > unictest_latest.txt 2>&1` to generate and capture error logs.
    -   Do not rely on cached knowledge; read file contents (especially `.bgn` definitions and generated `.hpp`) to verify types and structures.
    -   Analyze errors based *strictly* on the content of `unictest_latest.txt`. Verify the existence of error strings using `search_file_content` or `grep` before reporting.

2.  **Implementation Guidelines:**
    -   Use `ebm2python` as a reference implementation but adapt for C specificities.
    -   Use `script/ebmtemplate.py <TemplateName> c` to generate visitor hook templates.
    -   Modify `entry_before_class.hpp` to configure type wrappers (`optional_type_wrapper`, `recursive_struct_type_wrapper`) instead of implementing full visitor classes if default implementations suffice.
    -   Refer to `.bgn` files (e.g., `src/ebm/extended_binary_module.bgn`) to understand the exact structure of EBM nodes (e.g., `TypeKind::OPTIONAL` has `inner_type`, not `element_type`).

3.  **Specific Fixes & Logic:**
    -   **`Type_OPTIONAL`**:
        -   Implement using a struct wrapper `OPTIONAL_OF(type)` defined in `Statement_PROGRAM_DECL`.
        -   Use `s.body.inner_type()` to access the inner type, not `element_type()`.
        -   Remove pointer dereference (`*`) when accessing `OPTIONAL` type properties in `Expression_MEMBER_ACCESS`, and access `.value` instead (unless `merge_mode` is `STRICT_TYPE`).
    -   **`Type_RECURSIVE_STRUCT`**:
        -   Implement as a pointer (`T*`) in C to allow recursion via `recursive_struct_type_wrapper` configuration.
    -   **`Statement_SUB_BYTE_RANGE`**:
        -   Implement logic to create a sub-stream (pointer arithmetic on `data` and `data_end`).
    -   **`Union` Definitions**:
        -   Union definitions generated by `Statement_PROGRAM_DECL` are currently placed *inside* or *after* usage, causing `unknown type name` errors. They must be moved to be defined *before* the structs that use them.

## Status at End of Session

-   **Fixed:**
    -   `{{Unimplemented ...}}` errors for `Type_OPTIONAL`, `Type_RECURSIVE_STRUCT`, and `Statement_SUB_BYTE_RANGE` are resolved.
    -   `invalid type argument of unary '*'` errors related to `OPTIONAL` type dereferencing in `MEMBER_ACCESS` are resolved.
    -   `Unexpected nullptr` error caused by incorrect field access (`element_type` vs `inner_type`) in `collect_structs` is resolved.

-   **Pending:**
    -   **`Union` Definition Order:** `UnionXXX` types are still reported as unknown because they are defined too late in the generated C file.
    -   **Temporary Variable Types:** `tmpXXX` identifiers are being used as type names in function signatures, causing errors.
    -   **`OPTIONAL_OF` Redefinition:** Potential issue with duplicate macro/struct definitions for the same optional type (needs deduplication logic in `collect_structs`).

## Next Action Plan

1.  **Fix Union Definition Order:** Modify `src/ebmcg/ebm2c/visitor/Statement_PROGRAM_DECL_class.hpp` to generate all `Union` definitions before `Struct` definitions.
2.  **Investigate `tmpXXX` usage:** Debug why temporary variable names are leaking into type positions in generated code.
3.  **Deduplicate `OPTIONAL_OF`:** Add check in `collect_structs` to avoid multiple typedefs for the same optional type.
